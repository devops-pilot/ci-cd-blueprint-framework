name: CI/CD Dispatcher

on:
  push:
    paths:
      - '**/project-blueprint.yaml'
      - '**/*.java'
      - '**/*.py'
      - '**/*.js'
      - '.github/workflows/**'

jobs:
  read-blueprint:
    runs-on: ubuntu-latest
    outputs:
      language: ${{ steps.extract.outputs.language }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find project blueprint file
        id: extract
        run: |
          FILE=$(find . -type f -name project-blueprint.yaml | head -n 1)
          echo "Found blueprint: $FILE"
          echo "blueprint_path=$FILE" >> $GITHUB_OUTPUT
          LANG=$(yq e '.language' "$FILE")
          echo "language=$LANG" >> $GITHUB_OUTPUT
        env:
          YQ_VERSION: v4.40.5

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/yq_linux_amd64 -O /usr/bin/yq
          sudo chmod +x /usr/bin/yq

  java-ci:
    needs: read-blueprint
    if: ${{ needs.read-blueprint.outputs.language == 'java' }}
    uses: ./.github/workflows/java-ci.yml

  python-ci:
    needs: read-blueprint
    if: ${{ needs.read-blueprint.outputs.language == 'python' }}
    uses: ./.github/workflows/python-ci.yml

  node-ci:
    needs: read-blueprint
    if: ${{ needs.read-blueprint.outputs.language == 'node' }}
    uses: ./.github/workflows/node-ci.yml
